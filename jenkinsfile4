pipeline {
    agent none

    stages {
        stage('Terraform') {
            node('slave1') {
                try {
                    sh 'terraform init'
                    sh 'terraform apply'
                } catch (e) {
                    echo "Error on slave1, retrying on slave2"
                    node('slave2') {
                        retry(3) {
                            sh 'terraform init'
                            sh 'terraform apply'
                        }
                    }
                }
            }
        }
    }
}
